<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neon Dash X Ultimate</title>
<style>
body{
    margin:0;
    overflow:hidden;
    background:black;
    font-family:Arial;
    touch-action: manipulation;
}
canvas{ display:none; }

#loadingScreen{
    position:absolute;
    width:100%;
    height:100%;
    background:black;
    color:#ff00ff;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:40px;
    font-weight:bold;
    flex-direction:column;
    z-index:1000;
}

#menu{
    position:absolute;
    width:100%;
    height:100%;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    color:white;
    text-align:center;
    display:none;
}

input{
    padding:10px 15px;
    font-size:18px;
    border-radius:8px;
    border:none;
    margin-bottom:10px;
    text-align:center;
}

button{
    padding:15px 30px;
    font-size:18px;
    background:#ff00ff;
    border:none;
    border-radius:10px;
    color:white;
    cursor:pointer;
    box-shadow:0 0 20px #ff00ff;
    margin:5px;
}

.badge{
    display:inline-block;
    margin:2px 5px;
    padding:3px 8px;
    border-radius:5px;
    background:#ff00ff;
    box-shadow:0 0 10px #ff00ff;
    font-size:14px;
}

#skinGallery button{
    width:150px;
    height:50px;
    font-size:14px;
}
</style>
</head>
<body>

<div id="loadingScreen">
  LOADING...
  <div id="loadingDots">.</div>
</div>

<div id="menu">
<h1>‚ö° NEON DASH X ‚ö°</h1>

<div id="usernameInput">
<input type="text" id="usernameField" placeholder="Enter username"/>
<button onclick="saveUsername()">Start</button>
</div>

<h2 id="highScoreText"></h2>
<div id="rankText"></div>
<div id="badgesText"></div>

<button onclick="startGame()">START</button>
<button onclick="showChangeUsername()">Change Username</button>

<h3>Skin Gallery</h3>
<div id="skinGallery" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>

<div id="leaderboard" style="color:white; margin-top:20px;"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const menu = document.getElementById("menu");
const highScoreText = document.getElementById("highScoreText");
const rankText = document.getElementById("rankText");
const badgesText = document.getElementById("badgesText");
const usernameInputDiv = document.getElementById("usernameInput");
const usernameField = document.getElementById("usernameField");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
window.addEventListener("resize", ()=>{
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

let gravity, speed, score, stage;
let player, obstacles;
let shakeTime, flashAlpha;
let hue = 0;
let gameOver = false;

// High score & achievements
let highScore = parseInt(localStorage.getItem("neonDashHighScore")) || 0;
let savedAch = localStorage.getItem("ndxAchievements");
let achievements = savedAch ? JSON.parse(savedAch) : {doubleJump:false, spikesDodged50:false, stage3Reached:false, highScore100:false};

// Username system
let username = localStorage.getItem("ndxUsername") || null;
if(!username){
    usernameInputDiv.style.display="flex";
} else {
    usernameInputDiv.style.display="none";
}

// Skins system (last 3 have trail)
const skins = [
  {name:"Neon Pink", color:"#ff00ff", glow:true},
  {name:"Electric Blue", color:"#00ffff", glow:true, unlockScore:20},
  {name:"Lime Green", color:"#00ff00", glow:true, unlockScore:50},
  {name:"Fire Orange", color:"#ff9900", glow:true, unlockScore:100, trail:true},
  {name:"Ultra Violet", color:"#9900ff", glow:true, unlockScore:150, trail:true},
  {name:"Cyan Burst", color:"#00ffcc", glow:true, unlockScore:200, trail:true}
];
let selectedSkin = localStorage.getItem("ndxSkin") || "Neon Pink";

// Trail array
let trail = [];

// Save/load username
function saveUsername(){
    let name = usernameField.value.trim();
    if(name==="") name="Player";
    username=name;
    localStorage.setItem("ndxUsername", username);
    usernameInputDiv.style.display="none";
    alert("Welcome, "+username+"!");
}
function showChangeUsername(){
    let newName = prompt("Enter your new username:", username || "Player");
    if(newName && newName.trim() !== ""){
        username = newName.trim();
        localStorage.setItem("ndxUsername", username);
        alert("Username changed to " + username);
    }
}

// Initialize game
function init(){
gravity = 0.8;
speed = 6;
score = 0;
stage = 1;
shakeTime = 0;
flashAlpha = 0;
hue = 0;
gameOver = false;

player = {x:150, y:canvas.height-140, w:40, h:40, dy:0, jumpCount:0, rotation:0};
obstacles = [];
trail=[];
}

// Start game
function startGame(){
menu.style.display="none";
canvas.style.display="block";
init();
update();
}

// Return to menu and update rank/badges
function returnMenu(){
canvas.style.display="none";
menu.style.display="flex";
highScoreText.innerText="üèÜ Highest Score: "+highScore;
rankText.innerText="Rank: "+(localStorage.getItem("ndxRank") || calculateRank(highScore));
badgesText.innerHTML="Badges: "+displayBadges();
showSkinGallery();
showLeaderboard();
}

// Rank based on high score
function calculateRank(s){
    if(s<10) return "Beginner";
    if(s<30) return "Novice";
    if(s<60) return "Skilled";
    if(s<100) return "Advanced";
    return "Pro Neon Runner";
}

// Display badges
function displayBadges(){
    let b=[];
    for(let key in achievements){
        if(achievements[key]) b.push(key.replace(/([A-Z])/g, ' $1').toUpperCase());
    }
    return b.map(x=>`<span class="badge">${x}</span>`).join(" ");
}

// Skin gallery
function showSkinGallery(){
    const gallery = document.getElementById("skinGallery");
    gallery.innerHTML = "";
    skins.forEach(skin=>{
        let unlocked = !skin.unlockScore || highScore >= skin.unlockScore;
        let btn = document.createElement("button");
        btn.innerHTML = skin.name + "<br>" + (unlocked ? "Unlocked" : `Score ${skin.unlockScore} to unlock`);
        btn.style.background = skin.color;
        btn.style.color = "#fff";
        btn.style.border = selectedSkin===skin.name?"3px solid #fff":"none";
        btn.onclick = ()=>{
            if(unlocked){
                selectedSkin = skin.name;
                localStorage.setItem("ndxSkin", selectedSkin);
                showSkinGallery();
            } else {
                alert(`Unlock this skin at score ${skin.unlockScore}`);
            }
        }
        gallery.appendChild(btn);
    });
}

// Offline leaderboard
let leaderboard = JSON.parse(localStorage.getItem("ndxLeaderboard")||"[]");
function saveLeaderboard(){
    leaderboard.push({username:username||"Player", score:Math.floor(score)});
    leaderboard.sort((a,b)=>b.score-a.score);
    if(leaderboard.length>10) leaderboard=leaderboard.slice(0,10);
    localStorage.setItem("ndxLeaderboard", JSON.stringify(leaderboard));
}
function showLeaderboard(){
    const lbDiv = document.getElementById('leaderboard');
    let html="<h3>üèÜ Leaderboard üèÜ</h3>";
    leaderboard.forEach((p,i)=>{
        html+=`${i+1}. ${p.username}: ${p.score}<br>`;
    });
    lbDiv.innerHTML = html;
}

/* BACKGROUND */
function drawBackground(){
hue += 0.8;
let g = ctx.createLinearGradient(0,0,0,canvas.height);
g.addColorStop(0,`hsl(${hue},90%,30%)`);
g.addColorStop(1,`hsl(${hue+60},90%,15%)`);
ctx.fillStyle = g;
ctx.fillRect(0,0,canvas.width,canvas.height);

ctx.strokeStyle=`hsl(${hue},100%,60%)`;
ctx.lineWidth=5;
ctx.shadowBlur=25;
ctx.shadowColor=`hsl(${hue},100%,60%)`;
ctx.beginPath();
ctx.moveTo(0,canvas.height-100);
ctx.lineTo(canvas.width,canvas.height-100);
ctx.stroke();
ctx.shadowBlur=0;
}

/* GAME LOOP */
function spawnSpike(){
let gap = Math.max(260, 400 - stage*40);
if(obstacles.length===0 || canvas.width - obstacles[obstacles.length-1].x > gap){
let type = Math.random()>0.7 && stage>=3 ? "high":"low";
obstacles.push({x:canvas.width,type:type});
}
}

function update(){
ctx.clearRect(0,0,canvas.width,canvas.height);
let shakeX=0, shakeY=0;
if(shakeTime>0){shakeX=(Math.random()-0.5)*20;shakeY=(Math.random()-0.5)*20;shakeTime--;}
ctx.save();
ctx.translate(shakeX,shakeY);

drawBackground();

if(!gameOver){
player.dy+=gravity;
player.y+=player.dy;

if(player.y>=canvas.height-140){
player.y=canvas.height-140;
player.dy=0;
player.jumpCount=0;
player.rotation=0;
}

if(player.dy!==0) player.rotation+=0.2;

score+=0.05;
speed+=0.002;

if(score>20) stage=2;
if(score>50) {stage=3; achievements.stage3Reached=true;}
if(score>90) stage=4;
if(score>140) stage=5;

spawnSpike();
}

// Draw trail if skin has trail
let skin = skins.find(s=>s.name===selectedSkin);
if(skin.trail){
trail.push({x:player.x+20, y:player.y+20, alpha:0.5});
if(trail.length>20) trail.shift();
trail.forEach(t=>{
ctx.fillStyle = skin.color;
ctx.globalAlpha = t.alpha;
ctx.fillRect(t.x-20,t.y-20,40,40);
t.alpha -=0.02;
});
ctx.globalAlpha=1;
}

// draw player
ctx.save();
ctx.translate(player.x+20,player.y+20);
ctx.rotate(player.rotation);
ctx.shadowBlur = skin.glow ? 25 : 0;
ctx.shadowColor = skin.glow ? skin.color : "";
ctx.fillStyle = skin.color;
ctx.fillRect(-20,-20,40,40);
ctx.restore();

// draw spikes
obstacles.forEach(o=>{
o.x-=speed;
let spikeH=o.type==="high"?70:40;
let y=canvas.height-100;
let color=`hsl(${hue},100%,60%)`;

ctx.shadowBlur=20;
ctx.shadowColor=color;
ctx.fillStyle=color;

ctx.beginPath();
ctx.moveTo(o.x,y);
ctx.lineTo(o.x+40,y);
ctx.lineTo(o.x+20,y-spikeH);
ctx.closePath();
ctx.fill();
ctx.shadowBlur=0;

// collision
if(player.x<o.x+40 && player.x+player.w>o.x && player.y+player.h>y-spikeH){
if(!gameOver){
shakeTime=25;
flashAlpha=1;
gameOver=true;

if(Math.floor(score)>highScore){
highScore=Math.floor(score);
localStorage.setItem("neonDashHighScore",highScore);
if(highScore>=100) achievements.highScore100=true;

// Save rank
const newRank = calculateRank(highScore);
localStorage.setItem("ndxRank", newRank);
}

// Save achievements and leaderboard
localStorage.setItem("ndxAchievements", JSON.stringify(achievements));
saveLeaderboard();
setTimeout(returnMenu,900);
}
}
});

// track achievements
if(player.jumpCount>=2 && stage>=3) achievements.doubleJump=true;
if(Math.floor(score)>=50) achievements.spikesDodged50=true;

ctx.fillStyle="white";
ctx.font="20px Arial";
ctx.fillText("Player: "+(username||"Player"),20,20);
ctx.fillText("Score: "+Math.floor(score),20,45);
ctx.fillText("Stage: "+stage,20,70);
ctx.fillText("Rank: "+(localStorage.getItem("ndxRank") || calculateRank(highScore)),20,95);

ctx.restore();

if(flashAlpha>0){
ctx.fillStyle=`rgba(255,255,255,${flashAlpha})`;
ctx.fillRect(0,0,canvas.width,canvas.height);
flashAlpha-=0.05;
}

if(!gameOver) requestAnimationFrame(update);
}

/* INPUT */
function jump(){
if(!gameOver && player.jumpCount < (stage>=3?2:1)){
player.dy=-16;
player.jumpCount++;
}
}

document.addEventListener("keydown", jump);
document.addEventListener("click", jump);
document.addEventListener("touchstart", jump);

/* LOADING SCREEN */
let dots = 1;
const loadingDots = document.getElementById("loadingDots");
const loadingInterval = setInterval(()=>{
    dots = (dots%3)+1;
    loadingDots.innerText = ".".repeat(dots);
}, 500);

window.addEventListener("load", ()=>{
    setTimeout(()=>{
        document.getElementById("loadingScreen").style.display="none";
        clearInterval(loadingInterval);
        menu.style.display="flex"; // show menu after loading
        highScoreText.innerText="üèÜ Highest Score: "+highScore;
        rankText.innerText="Rank: "+(localStorage.getItem("ndxRank") || calculateRank(highScore));
        badgesText.innerHTML="Badges: "+displayBadges();
        showSkinGallery();
        showLeaderboard();
    },1500);
});
</script>
</body>
</html>
